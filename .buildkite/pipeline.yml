agents:
  queue: central
  slurm_mem: 8G
  modules: julia/1.8.5 openmpi/4.1.1 cuda/11.3 hdf5/1.12.1-ompi411 nsight-systems/2022.2.1

env:
  JULIA_LOAD_PATH: "${JULIA_LOAD_PATH}:${BUILDKITE_BUILD_CHECKOUT_PATH}/.buildkite"
  JULIA_CUDA_USE_BINARYBUILDER: false
  OPENBLAS_NUM_THREADS: 1
  JULIA_NVTX_CALLBACKS: gc

steps:
  - label: "initialize"
    key: "initialize"
    command:
      - echo "--- Instantiate project"
      - "julia --project -e 'using Pkg; Pkg.instantiate(;verbose=true); Pkg.precompile(;strict=true)'"
      # force the initialization of the CUDA runtime as it is lazily loaded by default
      - "julia --project -e 'using CUDA; CUDA.precompile_runtime()'"
      - "julia --project -e 'using Pkg; Pkg.status()'"

    agents:
      slurm_cpus_per_task: 8
    env:
      JULIA_NUM_PRECOMPILE_TASKS: 8

  - wait

  - group: "Run"
    steps:

      - label: ":computer: steady state"
        key: "cpu_steadystate"
        command:
          - nsys profile --trace=nvtx --output=output/cpu_steadystate/report julia --color=yes --project -e 'using ClimaShallowWater; ClimaShallowWater.run()' -- --output-dir=output/cpu_steadystate
        artifact_paths:
          - output/cpu_steadystate/*

      - label: ":flower_playing_cards: steady state"
        key: "gpu_steadystate"
        command:
          - nsys profile --trace=nvtx,cuda --output=output/gpu_steadystate/report julia --color=yes --project -e 'using ClimaShallowWater; ClimaShallowWater.run()' -- --output-dir=output/gpu_steadystate
        artifact_paths:
          - output/gpu_steadystate/*
        agents:
          slurm_gpus: 1

      - label: ":flower_playing_cards: steady state high res"
        key: "gpu_steadystate_res"
        command:
          - nsys profile --trace=nvtx,cuda --output=output/gpu_steadystate_res/report julia --color=yes --project -e 'using ClimaShallowWater; ClimaShallowWater.run()' -- --output-dir=output/gpu_steadystate_res --panel-size=32 --time-step=60
        artifact_paths:
          - output/gpu_steadystate_res/*
        agents:
          slurm_gpus: 1
